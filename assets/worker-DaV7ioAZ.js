(function(){"use strict";const B=(a,e)=>{const{width:t,height:o,data:r}=a,I=Math.ceil(t/e),y=Math.ceil(o/e),c=new Uint8Array(Math.ceil(t/e)*Math.ceil(o/e));let m=0;for(let R=0;R<o;R+=e)for(let A=0;A<t;A+=e){let h=!1;for(let g=0;g<e&&!h;g++)for(let d=0;d<e&&!h;d++){const P=A+d,k=R+g;if(P<t&&k<o){const F=(k*t+P)*4;r[F+3]>10&&(h=!0)}}c[m++]=h?1:0}return{validBlocks:c,blockWidth:I,blockHeight:y}},C=(a,e)=>{const n=Math.ceil(a),t=Math.floor(e);return Math.floor(Math.random()*(t-n)+n)};let u=[],w,f,s,l,i,x,T;const E=async a=>{i=a,x=i.getContext("bitmaprenderer"),s=new OffscreenCanvas(i.width,i.height),l=s.getContext("2d",{willReadFrequently:!0}),l.drawImage(w,0,0)},v=async a=>{const{imageBitmap:e,canvas:n,dimensions:t}=a;w=e,E(n);const{validBlocks:o,blockHeight:r,blockWidth:I}=B(l.getImageData(0,0,i.width,i.height),2);u=D({validBlocks:o,dimensions:t,radius:2,blockHeight:r,blockWidth:I})},M=a=>{let e=!0;l.clearRect(0,0,s.width,s.height),u.forEach(t=>{T(t),l.drawImage(w,t.targetX,t.targetY,2,2,Math.floor(t.x),Math.floor(t.y),2,2),(t.x!==t.targetX||t.y!==t.targetY)&&(e=!1)});const n=s.transferToImageBitmap();x.transferFromImageBitmap(n),e?(self.postMessage({type:"particlesReachedTarget"}),f&&cancelAnimationFrame(f)):f=requestAnimationFrame(()=>M())};self.onmessage=a=>{const{data:e,type:n}=a.data;switch(n){case"initialize":{v(e),self.postMessage({type:"initialized"});break}case"play":{T=new Function(e.code)(),M(e.movement);break}case"reset":{u.forEach(o=>{o.x=C(0,i.width),o.y=C(0,i.height)}),l.clearRect(0,0,s.width,s.height);const t=s.transferToImageBitmap();x.transferFromImageBitmap(t),f&&cancelAnimationFrame(f);break}}};const D=({validBlocks:a,dimensions:e,radius:n,blockHeight:t,blockWidth:o})=>{const r=[],{width:I,height:y}=e;for(let c=0;c<t;c++)for(let m=0;m<o;m++){const R=c*o+m;if(a[R]){const A=m*n,h=c*n,g=C(0,I),d=C(0,y);r.push({targetX:A,targetY:h,x:g,y:d,initialX:g,initialY:d})}}return console.log("Particles amount: ",r.length),r}})();
