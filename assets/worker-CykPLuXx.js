(function(){"use strict";const H=(o,t)=>{const{width:e,height:a,data:n}=o,i=Math.ceil(e/t),f=Math.ceil(a/t),I=new Uint8Array(Math.ceil(e/t)*Math.ceil(a/t));let v=0;for(let x=0;x<a;x+=t)for(let k=0;k<e;k+=t){let h=!1;for(let R=0;R<t&&!h;R++)for(let F=0;F<t&&!h;F++){const _=k+F,A=x+R;if(_<e&&A<a){const E=(A*e+_)*4;n[E+3]>10&&(h=!0)}}I[v++]=h?1:0}return{validBlocks:I,blockWidth:i,blockHeight:f}},Y=({dimensions:{width:o,height:t}})=>({top:()=>({x:Math.random()*o,y:0}),center:()=>({x:Math.round(o/2),y:Math.round(t/2)}),bottom:()=>({x:Math.random()*o,y:t}),random:()=>({x:Math.random()*o,y:Math.random()*t}),left:()=>({x:0,y:Math.random()*t}),right:()=>({x:o,y:Math.random()*t}),"top-left":()=>({x:Math.random()*(o/5),y:Math.random()*(t/5)}),"top-right":()=>({x:o,y:Math.random()*(t/5)}),"bottom-left":()=>({x:Math.random()*(o/5),y:t-Math.random()*(t/5)}),"bottom-right":()=>({x:o-Math.random()*(o/5),y:t-Math.random()*(t/5)})});let g=[],u,c,l,m,d,P,s,b,M,B,y,w,p;const W=async o=>{d=o,P=d.getContext("bitmaprenderer"),l=new OffscreenCanvas(d.width,d.height),m=l.getContext("2d",{willReadFrequently:!0})},X=async o=>{const{imageBitmap:t,canvas:r,dimensions:e,particleRadius:a}=o;u=t,s=a,y=o.startPosition,W(r),m.drawImage(u,0,0);const{validBlocks:n,blockHeight:i,blockWidth:f}=H(m.getImageData(0,0,d.width,d.height),s);b=n,M=i,B=f,p=Y({dimensions:e}),g=T({validBlocks:b,radius:s,blockHeight:M,blockWidth:B,startPosition:y})},C=(o,t)=>{let r=!0;m.clearRect(0,0,l.width,l.height),g.forEach(a=>{w(a,o,t),m.drawImage(u,a.targetX,a.targetY,s,s,Math.floor(a.x),Math.floor(a.y),s,s),(a.x!==a.targetX||a.y!==a.targetY)&&(r=!1)});const e=l.transferToImageBitmap();P.transferFromImageBitmap(e),r?(self.postMessage({type:"particlesReachedTarget"}),c&&cancelAnimationFrame(c)):c=requestAnimationFrame(a=>C(o,a))};self.onmessage=o=>{const{data:t,type:r}=o.data;switch(r){case"initialize":{X(t),self.postMessage({type:"initialized"});break}case"resizeParticleRadius":{s=t.particleRadius,m.drawImage(u,0,0);const{validBlocks:e,blockHeight:a,blockWidth:n}=H(m.getImageData(0,0,d.width,d.height),s);if(b=e,M=a,B=n,g=T({validBlocks:b,radius:s,blockHeight:M,blockWidth:B,startPosition:y}),c){cancelAnimationFrame(c);const i=performance.now();C(i,i)}break}case"play":{w=new Function(t.code)();const e=performance.now();C(e,e);break}case"updateStartPosition":{if(y=t.startPosition,g.length){if(g.forEach(e=>{const a=p[t.startPosition]();e.x=a.x,e.y=a.y}),c){cancelAnimationFrame(c);const e=performance.now();C(e,e)}}else console.error("updateStartPosition failed, particles were not initialized",{workerParticles:g});break}case"reset":{g.forEach(a=>{const n=p[y]();a.x=n.x,a.y=n.y}),m.clearRect(0,0,l.width,l.height);const e=l.transferToImageBitmap();P.transferFromImageBitmap(e),c&&cancelAnimationFrame(c);break}}};const T=({validBlocks:o,radius:t,blockHeight:r,blockWidth:e,startPosition:a})=>{const n=[];for(let i=0;i<r;i++)for(let f=0;f<e;f++){const I=i*e+f;if(o[I]){const v=f*t,x=i*t,{x:k,y:h}=p[a]();n.push({targetX:v,targetY:x,x:k,y:h,initialX:k,initialY:h})}}return console.log("Particles amount: ",n.length),n}})();
